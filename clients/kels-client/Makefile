.PHONY: simulator build build-ffi clean help list-simulators resolve

# Project settings
SCHEME = KelsClient
PROJECT = KelsClient.xcodeproj
SIMULATOR_NAME ?= iPhone 17 Pro
BUILD_DIR = .build
DERIVED_DATA = $(BUILD_DIR)/DerivedData

# Developer tools (set DEV_TOOLS=1 to enable developer tab)
DEV_TOOLS ?= 0

# Registry prefix from environment or .kels file
REGISTRY_PREFIX ?= $(shell cat ../../.kels/registry_prefix 2>/dev/null || echo "")

# Compute feature flags based on DEV_TOOLS
ifeq ($(DEV_TOOLS),1)
CARGO_FEATURES = secure-enclave,dev-tools
SWIFT_FLAGS = -DDEV_TOOLS
C_FLAGS = -DDEV_TOOLS
else
CARGO_FEATURES = secure-enclave
SWIFT_FLAGS =
C_FLAGS =
endif

# Build libkels-ffi for iOS Simulator (arm64)
build-ffi:
	@echo "Building libkels-ffi for iOS Simulator..."
ifeq ($(DEV_TOOLS),1)
	@echo "  DEV_TOOLS enabled"
endif
	cd ../.. && cargo build -p libkels-ffi --release --features $(CARGO_FEATURES) --target aarch64-apple-ios-sim

# Build the iOS app
build: build-ffi
	@echo "Building $(SCHEME)..."
ifeq ($(REGISTRY_PREFIX),)
	$(error REGISTRY_PREFIX not set. Run 'garden run fetch-registry-prefix' in the registry environment first, or set REGISTRY_PREFIX manually)
endif
	@echo "Using registry prefix: $(REGISTRY_PREFIX)"
ifeq ($(DEV_TOOLS),1)
	@echo "DEV_TOOLS enabled"
endif
	@# Generate Swift file with registry prefix
	@echo "// Auto-generated file - DO NOT EDIT" > KelsClientApp/Generated.swift
	@echo "// Generated by Makefile" >> KelsClientApp/Generated.swift
	@echo "" >> KelsClientApp/Generated.swift
	@echo "let REGISTRY_PREFIX = \"$(REGISTRY_PREFIX)\"" >> KelsClientApp/Generated.swift
	@SIMULATOR_ID=$$(xcrun simctl list devices | grep "$(SIMULATOR_NAME)" | grep -v "unavailable" | head -1 | sed -E 's/.*\(([0-9A-F-]+)\).*/\1/'); \
	if [ -z "$$SIMULATOR_ID" ]; then \
		echo "Error: Simulator '$(SIMULATOR_NAME)' not found"; \
		echo "Available simulators:"; \
		xcrun simctl list devices | grep -v "unavailable" | grep "iPhone"; \
		exit 1; \
	fi; \
	xcodebuild -project $(PROJECT) \
		-scheme $(SCHEME) \
		-destination "id=$$SIMULATOR_ID" \
		-configuration Debug \
		-derivedDataPath $(DERIVED_DATA) \
		OTHER_SWIFT_FLAGS="$(SWIFT_FLAGS)" \
		OTHER_CFLAGS="$(C_FLAGS)" \
		GCC_PREPROCESSOR_DEFINITIONS="$(if $(filter 1,$(DEV_TOOLS)),DEV_TOOLS=1,) \$$(inherited)" \
		build

# Build and launch in simulator
simulator: build
	@echo "Launching app in simulator..."
	@APP_PATH=$$(find $(DERIVED_DATA) -name "$(SCHEME).app" -type d | head -1); \
	if [ -z "$$APP_PATH" ]; then \
		echo "Error: Could not find built app"; \
		exit 1; \
	fi; \
	echo "Found app at: $$APP_PATH"; \
	SIMULATOR_ID=$$(xcrun simctl list devices | grep "$(SIMULATOR_NAME)" | grep -v "unavailable" | head -1 | sed -E 's/.*\(([0-9A-F-]+)\).*/\1/'); \
	if [ -z "$$SIMULATOR_ID" ]; then \
		echo "Error: Simulator '$(SIMULATOR_NAME)' not found"; \
		exit 1; \
	fi; \
	echo "Using simulator: $$SIMULATOR_ID ($(SIMULATOR_NAME))"; \
	xcrun simctl boot $$SIMULATOR_ID 2>/dev/null || true; \
	open -a Simulator; \
	sleep 2; \
	echo "Installing app..."; \
	xcrun simctl install $$SIMULATOR_ID "$$APP_PATH"; \
	BUNDLE_ID=$$(/usr/libexec/PlistBuddy -c "Print CFBundleIdentifier" "$$APP_PATH/Info.plist"); \
	echo "Launching app with bundle ID: $$BUNDLE_ID"; \
	xcrun simctl launch --console $$SIMULATOR_ID $$BUNDLE_ID

# Resolve Swift package dependencies
resolve:
	@echo "Resolving Swift package dependencies..."
	swift package resolve

# Clean build artifacts
clean:
	@echo "Cleaning build artifacts..."
	@rm -rf $(BUILD_DIR)
	@rm -f KelsClientApp/Generated.swift
	@echo "Build artifacts cleaned"

# List available simulators
list-simulators:
	@echo "Available iOS simulators:"
	@xcrun simctl list devices | grep -v "unavailable" | grep "iPhone"

# Help
help:
	@echo "KELS iOS App - Makefile"
	@echo ""
	@echo "Available targets:"
	@echo "  make simulator        - Build and run app in simulator"
	@echo "  make build            - Build app for simulator"
	@echo "  make build-ffi        - Build libkels-ffi for iOS Simulator"
	@echo "  make clean            - Clean build artifacts"
	@echo "  make list-simulators  - List available iOS simulators"
	@echo "  make help             - Show this help message"
	@echo ""
	@echo "Environment variables:"
	@echo "  SIMULATOR_NAME        - Target simulator (default: $(SIMULATOR_NAME))"
	@echo "  DEV_TOOLS             - Enable developer tools tab (0 or 1, default: 0)"
	@echo "  REGISTRY_PREFIX       - Trusted registry prefix (from .kels/registry_prefix)"
	@echo ""
	@echo "Examples:"
	@echo "  make simulator SIMULATOR_NAME='iPhone 15'"
	@echo "  make simulator DEV_TOOLS=1      # With developer tools"
