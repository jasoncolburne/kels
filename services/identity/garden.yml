kind: Build
name: identity
type: container

# Identity service is only needed in the registry environment
disabled: ${var.envType != "registry"}

dependencies:
  - run.read-federation-prefixes

source:
  path: ../..  # Set build context to repository root

include:
  - lib/kels/**/*
  - lib/kels-derive/**/*
  - services/identity/**/*
  - project.garden.yml
  - .kels/federated-registries.json

spec:
  dockerfile: services/identity/Dockerfile
  buildArgs:
    # TRUSTED_REGISTRY_PREFIXES is compiled into the binary for security
    TRUSTED_REGISTRY_PREFIXES: ${actions.run.read-federation-prefixes.outputs.log}

---

kind: Deploy
name: identity
type: kubernetes

# Identity service is only needed in the registry environment
disabled: ${var.envType != "registry"}

dependencies:
  - build.identity
  - deploy.postgres
  - deploy.hsm

variables:
  identityDatabaseUrl: ${var.postgres.url}/identity
  identityKeyHandlePrefix: kels-registry

spec:
  manifestTemplates:
    - manifests.yml.tpl
