kind: Build
name: kels-registry
type: container

disabled: ${var.envType != "registry"}

dependencies:
  - run.read-federation-prefixes

source:
  path: ../..  # Set build context to repository root

include:
  - lib/kels/**/*
  - lib/kels-derive/**/*
  - services/kels-registry/**/*
  - project.garden.yml
  - .kels/federated-registries.json

spec:
  dockerfile: services/kels-registry/Dockerfile
  buildArgs:
    TRUSTED_REGISTRY_PREFIXES: ${actions.run.read-federation-prefixes.outputs.log}

---

kind: Deploy
name: kels-registry
type: kubernetes

disabled: ${var.envType != "registry"}

dependencies:
  - build.kels-registry
  - deploy.redis
  - deploy.postgres
  - deploy.identity
  - run.read-federation-self-prefix
  - run.read-federation-members

variables:
  kelsRegistryDatabaseUrl: ${var.postgres.url}/kels_registry
  identityUrl: ${var.identity.url}
  federationSelfPrefix: ${actions.run.read-federation-self-prefix.outputs.log}
  federationUrls: ${actions.run.read-federation-members.outputs.log}

spec:
  manifestTemplates:
    - manifests.yml.tpl

---

kind: Run
name: fetch-registry-prefix
type: exec

disabled: ${var.envType != "registry"}

dependencies:
  - deploy.identity

spec:
  command:
    - bash
    - ../../scripts/fetch-registry-prefix.sh
    - ${environment.name}
    - ${environment.namespace}
    - ../..

---

# Propose core peer actions (creates proposal, outputs proposal ID)

kind: Run
name: propose-node-a
type: exec

source:
  path: ../..

disabled: ${var.envType != "registry"}

dependencies:
  - deploy.kels-registry

spec:
  command:
    - bash
    - scripts/propose-peer.sh
    - node-a

---

kind: Run
name: propose-node-b
type: exec

source:
  path: ../..

disabled: ${var.envType != "registry"}

dependencies:
  - deploy.kels-registry

spec:
  command:
    - bash
    - scripts/propose-peer.sh
    - node-b

---

kind: Run
name: propose-node-c
type: exec

source:
  path: ../..

disabled: ${var.envType != "registry"}

dependencies:
  - deploy.kels-registry

spec:
  command:
    - bash
    - scripts/propose-peer.sh
    - node-c

---

# Vote on a peer proposal (pass proposal ID via --var proposal=<id>)

kind: Run
name: vote-peer
type: exec

source:
  path: ../..

disabled: ${var.envType != "registry"}

dependencies:
  - deploy.kels-registry

spec:
  command:
    - bash
    - scripts/vote-peer.sh
    - ${var.proposal}
    - ${environment.namespace}

---

# Regional peer actions (direct add, no proposal needed)

kind: Run
name: add-regional-node-d
type: exec

source:
  path: ../..

disabled: ${var.envType != "registry"}

dependencies:
  - deploy.kels-registry

spec:
  command:
    - bash
    - scripts/add-regional-node.sh
    - node-d
    - ${environment.namespace}
---

kind: Run
name: add-regional-node-e
type: exec

source:
  path: ../..

disabled: ${var.envType != "registry"}

dependencies:
  - deploy.kels-registry

spec:
  command:
    - bash
    - scripts/add-regional-node.sh
    - node-e
    - ${environment.namespace}
---

kind: Run
name: add-regional-node-f
type: exec

source:
  path: ../..

disabled: ${var.envType != "registry"}

dependencies:
  - deploy.kels-registry

spec:
  command:
    - bash
    - scripts/add-regional-node.sh
    - node-f
    - ${environment.namespace}
